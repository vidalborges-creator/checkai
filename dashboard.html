<div id="modalAcao" class="modal-gestao">
    <div class="modal-content">
        <h2 id="tituloAcao">Finalizar Registro</h2>
        
        <div id="areaFormulario">
            <div class="input-group">
                <label id="labelTexto">Justificativa / Observações (Obrigatório):</label>
                <textarea id="textoAcao" rows="4" placeholder="Digite aqui..."></textarea>
            </div>

            <div id="camposConcluir">
                <div class="flag-container">
                    <input type="checkbox" id="fotoNaoAplicavel" onchange="toggleFotoField()">
                    <label for="fotoNaoAplicavel">Foto não aplicável para esta conclusão</label>
                </div>
                
                <div id="grupoFoto" class="input-group">
                    <label>Foto da Ação de Melhoria (Obrigatório):</label>
                    <input type="file" id="fotoConclusao" accept="image/*" capture="camera">
                </div>
            </div>

            <div id="camposEncaminhar" style="display:none;">
                <div class="input-group">
                    <label>E-mail do Destinatário (Obrigatório):</label>
                    <input type="email" id="emailDestino" placeholder="exemplo@email.com">
                </div>
                <div class="input-group">
                    <label>Dados Complementares (Obrigatório):</label>
                    <textarea id="dadosComplementares" rows="3" placeholder="Informações adicionais..."></textarea>
                </div>
            </div>
        </div>

        <div class="modal-footer">
            <button class="btn-confirmar" onclick="validarEProcessar()">CONFIRMAR</button>
            <button class="btn-cancelar" onclick="fecharModalAcao()">CANCELAR</button>
        </div>
    </div>
</div>

<script>
// Controla a exibição do campo de foto
function toggleFotoField() {
    const isNA = document.getElementById('fotoNaoAplicavel').checked;
    const campoFoto = document.getElementById('grupoFoto');
    campoFoto.style.display = isNA ? 'none' : 'block';
}

function abrirModalConcluir(id) {
    itemParaProcessar = id;
    tipoAcaoAtual = 'concluir';
    document.getElementById('tituloAcao').innerText = "Concluir Melhoria";
    document.getElementById('camposConcluir').style.display = 'block';
    document.getElementById('camposEncaminhar').style.display = 'none';
    document.getElementById('modalAcao').style.display = 'flex';
}

function abrirModalEncaminhar(id) {
    itemParaProcessar = id;
    tipoAcaoAtual = 'encaminhar';
    document.getElementById('tituloAcao').innerText = "Encaminhar Ocorrência";
    document.getElementById('camposConcluir').style.display = 'none';
    document.getElementById('camposEncaminhar').style.display = 'block';
    document.getElementById('modalAcao').style.display = 'flex';
}

async function validarEProcessar() {
    const texto = document.getElementById('textoAcao').value;
    if (!texto) return alert("O texto descritivo é obrigatório!");

    let dados = JSON.parse(localStorage.getItem('ocorrencias'));
    let idx = dados.findIndex(o => o.id === itemParaProcessar);

    if (tipoAcaoAtual === 'concluir') {
        const fotoNA = document.getElementById('fotoNaoAplicavel').checked;
        const arquivoFoto = document.getElementById('fotoConclusao').files[0];

        if (!fotoNA && !arquivoFoto) {
            return alert("A foto é obrigatória, ou marque 'Foto não aplicável'.");
        }

        // Se tiver foto, converte para salvar
        if (arquivoFoto && !fotoNA) {
            dados[idx].foto_conclusao = await toBase64(arquivoFoto);
        }
        
        dados[idx].status_fluxo = "Solicitado: Concluir";
        dados[idx].ultima_obs = texto;

    } else if (tipoAcaoAtual === 'encaminhar') {
        const email = document.getElementById('emailDestino').value;
        const dadosComp = document.getElementById('dadosComplementares').value;

        if (!email || !dadosComp) return alert("E-mail e Dados Complementares são obrigatórios!");

        dados[idx].status_fluxo = "Encaminhado";
        dados[idx].email_encaminhado = email;
        dados[idx].ultima_obs = `Encaminhado para ${email}. Mensagem: ${texto}. Dados: ${dadosComp}`;
    }

    localStorage.setItem('ocorrencias', JSON.stringify(dados));
    location.reload();
}
</script>