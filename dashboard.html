<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Controle - CheckAi</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        
        .btn-novo { 
            background: #2ecc71; color: white; text-decoration: none; padding: 15px 25px; 
            border-radius: 12px; font-weight: bold; display: inline-flex; align-items: center; gap: 10px;
            box-shadow: 0 4px 15px rgba(46,204,113,0.3); transition: 0.3s; margin-bottom: 20px; border: none; cursor: pointer;
        }

        .card { 
            background: white; border-radius: 20px; padding: 25px; margin-bottom: 15px; 
            box-shadow: 0 8px 20px rgba(0,0,0,0.05); border-left: 10px solid #f1c40f;
        }

        .status-badge { background: #95a5a6; color: white; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: bold; }

        .actions-bar { display: flex; gap: 10px; border-top: 1px solid #eee; padding-top: 15px; margin-top: 15px; }
        .btn-action { 
            border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; 
            font-size: 13px; font-weight: bold; display: flex; align-items: center; gap: 6px; color: white;
        }

        /* Estilo idêntico à imagem image_e222df */
        .btn-enc { background: #3498db; }
        .btn-con { background: #2ecc71; }
        .btn-can { background: #e67e22; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); align-items: center; justify-content: center; }
        .modal-box { background: white; padding: 30px; border-radius: 20px; width: 90%; max-width: 400px; }
        input, textarea { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <a href="index.html" style="text-decoration:none; color:#3498db; font-weight:bold;">← Voltar</a>
        <h2 style="margin:0;">Painel de Controle</h2>
    </div>

    <a href="registro.html" class="btn-novo">
        <i class="fas fa-plus"></i> NOVO REGISTRO
    </a>

    <div id="listaOcorrencias">
        </div>
</div>

<div id="modalApp" class="modal">
    <div class="modal-box">
        <h3 id="mTitulo">Ação</h3>
        <div id="mCampos"></div>
        <button onclick="salvarAcao()" id="mBotao" style="width:100%; padding:15px; border-radius:12px; border:none; color:white; font-weight:bold; cursor:pointer; margin-top:10px;"></button>
        <button onclick="fecharModal()" style="width:100%; background:none; border:none; color:gray; cursor:pointer; margin-top:10px; width:100%;">Cancelar</button>
    </div>
</div>

<script>
    let itemAtualId = null;
    let tipoAtual = "";

    function renderizar() {
        const container = document.getElementById('listaOcorrencias');
        // Importante: garante que 'ocorrencias' exista como array
        const dados = JSON.parse(localStorage.getItem('ocorrencias') || '[]');

        if (dados.length === 0) {
            container.innerHTML = `<div style="text-align:center; padding:50px; color:#999; background:white; border-radius:20px;">Nenhum registro encontrado. Clique em "Novo Registro" para começar.</div>`;
            return;
        }

        // Ordenação: Mais recente primeiro
        dados.sort((a, b) => b.id - a.id);

        container.innerHTML = dados.map(occ => `
            <div class="card">
                <h3 style="margin:0;">${occ.setor || '1'} - ${occ.local || '1'}</h3>
                <p style="margin:10px 0;">Status: <span class="status-badge">${occ.status_fluxo || 'Pendente'}</span></p>
                <div class="actions-bar">
                    <button class="btn-action btn-enc" onclick="abrir('Encaminhar', ${occ.id})"><i class="fas fa-paper-plane"></i> Encaminhar</button>
                    <button class="btn-action btn-con" onclick="abrir('Concluir', ${occ.id})"><i class="fas fa-check"></i> Concluir</button>
                    <button class="btn-action btn-can" onclick="abrir('Cancelar', ${occ.id})"><i class="fas fa-times"></i> Cancelar</button>
                </div>
            </div>
        `).join('');
    }

    function abrir(tipo, id) {
        itemAtualId = id;
        tipoAtual = tipo;
        const m = document.getElementById('modalApp');
        const t = document.getElementById('mTitulo');
        const c = document.getElementById('mCampos');
        const b = document.getElementById('mBotao');

        m.style.display = "flex";
        c.innerHTML = "";

        if(tipo === 'Encaminhar') {
            t.innerText = "Encaminhar Registro";
            c.innerHTML = '<input type="email" id="f1" placeholder="E-mail destinatário" required><textarea id="f2" placeholder="Informações gerais" required></textarea>';
            b.innerText = "ENCAMINHAR AGORA";
            b.style.background = "#3498db";
        } else if(tipo === 'Concluir') {
            t.innerText = "Solicitar Conclusão";
            c.innerHTML = '<div id="f-foto"><input type="file" accept="image/*" onchange="window.preview(event)"><img id="p-img" style="width:100%; display:none; margin:10px 0; border-radius:10px;"></div><label style="font-size:12px;"><input type="checkbox" onchange="window.tog(this)"> Inativar obrigação de foto</label><textarea id="f2" placeholder="O que foi realizado?" required></textarea>';
            b.innerText = "SOLICITAR CONCLUSÃO";
            b.style.background = "#2ecc71";
        } else {
            t.innerText = "Solicitar Cancelamento";
            c.innerHTML = '<textarea id="f2" placeholder="Motivo do cancelamento" required></textarea>';
            b.innerText = "SOLICITAR CANCELAMENTO";
            b.style.background = "#e67e22";
        }
    }

    window.preview = (e) => {
        const reader = new FileReader();
        reader.onload = () => { const i = document.getElementById('p-img'); i.src = reader.result; i.style.display = "block"; };
        reader.readAsDataURL(e.target.files[0]);
    };

    window.tog = (cb) => { document.getElementById('f-foto').style.display = cb.checked ? 'none' : 'block'; };

    function fecharModal() { document.getElementById('modalApp').style.display = "none"; }

    function salvarAcao() {
        const obs = document.getElementById('f2').value;
        if(!obs) return alert("Preencha os campos obrigatórios!");

        let dados = JSON.parse(localStorage.getItem('ocorrencias') || '[]');
        let idx = dados.findIndex(o => o.id === itemAtualId);
        
        dados[idx].status_fluxo = "Solicitado: " + tipoAtual;
        localStorage.setItem('ocorrencias', JSON.stringify(dados));
        
        alert("Enviado com sucesso!");
        fecharModal();
        renderizar();
    }

    window.onload = renderizar;
</script>
</body>
</html>