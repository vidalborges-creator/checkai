<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pendências - CheckAi</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .card { 
            background: white; border-radius: 20px; padding: 25px; margin-bottom: 15px; 
            box-shadow: 0 8px 20px rgba(0,0,0,0.05); position: relative; border-left: 10px solid #ddd;
        }
        /* Estilos de borda por situação */
        .borda-alerta { border-left-color: #f39c12; } /* Aguardando */
        .borda-reprovado { border-left-color: #e74c3c; } /* Erro/Reprovado */

        .badge { padding: 5px 12px; border-radius: 8px; font-size: 11px; font-weight: bold; text-transform: uppercase; margin-bottom: 10px; display: inline-block; }
        .bg-reprovado { background: #fee2e2; color: #dc2626; }
        .bg-aguardando { background: #fef3c7; color: #d97706; }

        .motivo-box { background: #fff5f5; border: 1px solid #feb2b2; padding: 15px; border-radius: 12px; margin: 15px 0; color: #c53030; font-size: 14px; }
        .actions { display: flex; gap: 10px; margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px; }
        .btn { border: none; padding: 12px; border-radius: 10px; cursor: pointer; font-weight: bold; color: white; flex: 1; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-view { background: #34495e; }
        .btn-approve { background: #2ecc71; }
        .btn-reject { background: #e74c3c; }
        .btn-fix { background: #3498db; text-decoration: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <a href="index.html" style="text-decoration:none; color:#3498db; font-weight:bold;"><i class="fas fa-arrow-left"></i> Voltar</a>
        <h2 id="tituloPagina" style="margin:0; color: #2c3e50;">Pendências</h2>
    </div>
    <div id="listaPendencias"></div>
</div>

<script>
    const sessao = JSON.parse(localStorage.getItem('usuarioLogado'));

    function carregar() {
        const lista = document.getElementById('listaPendencias');
        const ocorrencias = JSON.parse(localStorage.getItem('ocorrencias') || '[]');
        let filtrados = [];

        // LÓGICA DE FILTRO:
        if (sessao.perfil === 'Gestor' || sessao.user === 'admin') {
            document.getElementById('tituloPagina').innerText = "Aprovações Pendentes";
            // Gestor vê o que foi solicitado (Concluir ou Cancelar)
            filtrados = ocorrencias.filter(o => o.status_fluxo === "Solicitado: Concluir" || o.status_fluxo === "Solicitado: Cancelar");
        } else {
            document.getElementById('tituloPagina').innerText = "Minhas Reprovações";
            // Colaborador vê itens que ELE enviou e que o GESTOR reprovou
            filtrados = ocorrencias.filter(o => o.status_fluxo === "Reprovado" && o.responsavel_login === sessao.user);
        }

        if (filtrados.length === 0) {
            lista.innerHTML = `<div style="text-align:center; padding:50px; color:gray;">Nenhuma pendência encontrada para seu perfil.</div>`;
            return;
        }

        lista.innerHTML = filtrados.map(o => {
            const ehReprovado = o.status_fluxo === "Reprovado";
            return `
                <div class="card ${ehReprovado ? 'borda-reprovado' : 'borda-alerta'}">
                    <span class="badge ${ehReprovado ? 'bg-reprovado' : 'bg-aguardando'}">
                        ${ehReprovado ? 'Reprovado pelo Gestor' : o.status_fluxo}
                    </span>
                    <h3 style="margin:0;">${o.descricao}</h3>
                    <p style="color:gray; font-size:14px;">${o.setor} | ${o.local}</p>
                    
                    ${ehReprovado ? `
                        <div class="motivo-box">
                            <strong><i class="fas fa-comment-dots"></i> Motivo da Reprovação:</strong><br>
                            ${o.motivo_reprovacao || 'Não informado'}
                        </div>
                    ` : ''}

                    <div class="actions">
                        ${ehReprovado ? `
                            <a href="dashboard.html" class="btn btn-fix"><i class="fas fa-edit"></i> CORRIGIR NO PAINEL</a>
                        ` : `
                            <button class="btn btn-approve" onclick="finalizar(${o.id}, true)">APROVAR</button>
                            <button class="btn btn-reject" onclick="finalizar(${o.id}, false)">REPROVAR</button>
                        `}
                    </div>
                </div>
            `;
        }).join('');
    }

    function finalizar(id, aprovado) {
        let dados = JSON.parse(localStorage.getItem('ocorrencias'));
        let idx = dados.findIndex(o => o.id === id);
        const statusAnterior = dados[idx].status_fluxo;

        if (aprovado) {
            dados[idx].status_fluxo = statusAnterior.includes("Concluir") ? "Concluído" : "Cancelado";
        } else {
            const motivo = prompt("Por que você está reprovando este item?");
            if (!motivo) return;
            dados[idx].status_fluxo = "Reprovado";
            dados[idx].motivo_reprovacao = motivo;
        }

        localStorage.setItem('ocorrencias', JSON.stringify(dados));
        carregar();
    }

    window.onload = carregar;
</script>
</body>
</html>